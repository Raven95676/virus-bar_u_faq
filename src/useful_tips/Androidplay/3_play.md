---
title: 玩机知识
author: shenapex
date: 2024-08-25
icon: fas fa-file
category:
  - 实用技巧
isOriginal: true
order: 3
---

## 五、镜像分区简介与注意

在上一章中，我们介绍到了在使用Magisk/KernelSU获取root时需提取、修补、刷入boot镜像，那么手机中都有哪些镜像分区？它们对我们刷机有哪些影响？在本章我们将进行介绍

### 1、分区架构简介

在介绍各镜像分区前我们先介绍两种常见的分区架构（分区架构有onlyA,AB,onlyA动态分区,AB动态分区,VAB架构），

AB架构与VAB架构
![OtG3mp.png](https://ooo.0x0.ooo/2024/08/25/OtG3mp.png)

图 1AB架构简图

AB架构：使用了两套System以对上一套系统进行备份，防止因系统更新/刷机失败后无法进入系统，可以进行无缝更新，防止因更新而打断用户使用，在进入A/B系统失败后，下次重启会自动尝试进入B/A系统，代价是由于占用了双份System空间，实际并无逻辑分区，本质上是虚拟镜像），所以占用大量用户空间，为解决此问题，谷歌在Android11＋引入了VAB架构。
![OtQMqY.png](https://ooo.0x0.ooo/2024/08/25/OtQMqY.png)

图 2VAB架构简图

VAB架构：逻辑分区依旧不存在，AB的的动态分区架构中，逻辑分区里面，不管是system_a还是system_b，都是可以刷写img镜像文件的，是真实存在的，有空间大小的AB分区来回切换的时候，system_a和system_b就会被来回切换着挂载到根目录而VAB架构呢？system_a是有空间大小的，但是system_b是没有分配空间大小的(空间占用0字节)。不管你切换到A分区，还是切换到B分区，它都只会挂载system_a。这个system_b不会被使用。具体它是怎么挂载的呢，我也说不清楚，谷歌开发者文档中也没有太多的介绍，我目前是按照我自己的刷机知识及经验推论出来的，不保证是100%正确，如果有大佬指出我的错误，那简直是雪中送炭：
1、A分区时，挂载system_a，并使用所有的_a分区。

2、B分区时，将system_a重命名为system_b，同时0字节大小的system_b也重命名为system_a，挂载重命名后的system_b，并使用所有的_b分区。

3、在系统内OTA更新时(假设当前是处于A分区，更新成功后为切换到B分区)，需要更新的系统补丁包，解压后存放在data分区，复制一份system_a，并重命名为system_b_tmp，放到data分区的某个隐藏目录中，将下载好的系统更新包，整合进复制出来的system_b_tmp，得到更新完整包system_b_tmp，重启手机，如果成功挂载system_b_tmp，那么就把system_b_tmp替换掉动态分区的system_a，并重命名为system_b，原本0字节的system_b重命名为system_a，并切换至b分区。更新完成。如果system_b_tmp更新失败，则不会动原有的分区，system_a分区依然原样。——来源Rannki大佬

**实际上VAB中不存在recovery分区！（注：骁龙八以后的新机型又把他恢复成了一个单独的分区。。）**，rec实际被集成到boot中的ramdisk，如果你要刷入第三方rec，不可以直接将rec镜像直接刷入boot！正确的办法比如先获取root后（详见第三章）在系统中使用某些工具（如多统工具籍）修补式刷入，若机子支持临时引导则可在bootloader模式下使用 ```fastboot boot path```命令临时引导进rec，再在rec的高级设置中修补永久安装。

### 2、镜像分区

- system:我们所使用的系统的文件在放在此处它的大小会影响开机速度，它的修改可能造成无法开机或无法正常使用

- product:厂商软件和一些OEM的存放处，OEM 厂商通过定制原生 system image 的方式来实现运营商相关 Feature 或需求。为了支持不同的语言、运营商等，每个 system image 都会不同，这样的定制无法通过唯一的 system image 来实现。因此，可以考虑这样的方式：使用一个和 system 分离开的 Prouduct 分区来包含定制内容。

- cust: cust 分区用于存储特定用户或特定市场的定制系统文件和配置。它包含了用户定制的系统文件和配置项，用于满足特定用户需求或特定市场的要求。它可能包括特定应用程序、主题、预装软件、语言文件、设置和其他用户定制的内容。一些ROM作者经常往此放置广告，因此也戏称为广告分区

- boot:①kernel:内核②ramdisk 虚拟内存小型恢复分区（recovery）③dtbo:GPU/CPU调度配置信息等

- vendor：主系统分区，主要是包含开发厂商定制的一些应用和库文件，很多时候开发厂商也直接将这个分区的内容直接放入system分区。

+ userdata：用户数据分区，存放用户数据，包括系统和用户安装的应用程序和使用时生成的数据，一是位于data的应用私有数据目录，一类是/sdcard实际为/data/media/0的挂载的应用公有目录，即我们平时在手机自带文件管理所看到的目录

- cache：临时存放数据的分区，通常用于存放OTA的升级包。

- recovery：存放传统Recovery系统的linux kernel文件和ramdisk（VAB架构中大部分不再存在，而是被集成到了boot中）

### 3、关于data解密与system镜像挂载失败的解决办法

data解密：先提取vendor分区修改data加密状态（篇幅问题） 通过Fastboot格式化data（会清除所有数据！）后解密（不建议解密！！这项是为了您的数据安全着想，若第三方rec支持解密data），[参考教程](https://www.coolapk.com/feed/33153235)

system挂载失败解决办法：（仅适用于因EROFS导致的无法读写）利用DNA脚本（或软件）去除校验后刷入，[参考教程](https://www.coolapk.com/feed/33153235)：

### 4、刷写镜像分区与救砖

由于VAB中谷歌引入Super动态分区的概念导致我们无法直接在fastboot下刷写system，vendor等分区，谷歌引入了Fastbootd模式以方便刷写Super中的各类分区，原先的fastboot则用来刷写super，boot等分区

![OtQOAv.png](https://ooo.0x0.ooo/2024/08/25/OtQOAv.png)

图 3各模式下可刷写的分区不同

而第三方recovery不仅支持刷写bootloader和fastbootd能刷写的分区，部分定制还可直接解密data（第三方rec实际上就是很多已经编译好的脚本直接用来跑，使用rec刷机又称卡刷）

部分厂商专用刷机工具及所处模式
![OtQaSq.png](https://ooo.0x0.ooo/2024/08/25/OtQaSq.png)

图 4厂商专用刷机工具

Oppo/1+提供的是高通平台的9008刷机，也就是深度救砖
![OtQoCc.png](https://ooo.0x0.ooo/2024/08/25/OtQoCc.png)

图 5 深度救砖

当我们rec和fastboot都进不去时，就只有尝试使用9008进行救砖，但是现在一般都要有授权才能进入9008进行刷机，我们可以尝试在某宝找人帮你

>[!note]
>常见变砖情况
>
>①卡一屏：可能是没有解锁bl就去刷机导致的，也有可能是卡AVB2.0校验，去除即可
>
>②卡二屏：系统损坏或出现问题，可以先尝试停用所有模块（包括magisk和xposed），也有可能是因为dm校验，可以去rec里去除dm校验试试……
>
>③基带/IMEI丢失：刷回基带备份即可（所以一定要注意提前备份！！），小米手机若是开发版也可尝试使用```*#*#2527337#*#*```恢复基带？
>
>④开机键无反应：先检查是不是电源键坏了或者没电了，如果不是，大概率黑砖了，需要9008救砖
>
>⑤进不了系统，开机自动进入Fastboot：大概率是卡AVB2.0校验，去除校验即可，也有可能是分区损坏（乱刷boot吧嘻嘻）
>
>⑥进不了Fastboot，只能进recovery：不好说……可能是boot损坏，9008下刷入boot试试？
>

## 六、xposed安装与使用

### 1、什么是xposed？

xposed，一个在不修改软件安装包和系统框架的情况下影响/修改它们的行为的开源框架，经历了xposed （Android9以下）-Exposed （Android8-10）--LSPosed（Android11＋至今）的迭代（非同一批开发者！），而免root的框架从太极，应用转生到LSpatch的迭代，它们的作用很大， 比如如果我们想修改系统底层，一方面由于安卓限制我们不能直接修改/System，另一 方面又怕乱改导致进不去系统，这时我们就可以使用xposed来hook系统框架以防让此类事情发生，再比如有时我们为 了破解或者增删一些软件的功能，会尝试去修改安装包以达到目的，但大部分厂商都加强了对盗版的打击，签名效验/加固 /SSL固定证书校验等方式层出不穷，这对我们改包带来了很大的困难，有时无从下手，这时我们可以考虑使用xposed以达到不修改安装包仍可影响软件行为的目的（服务器验证纯纯自慰！）

### 2、安装xposed

（鉴于目前迭代更新速度极快，我们将只讨论Android10以上的情况）首先，如果你的手机能解锁，那么我们更推荐使用Zygisk-LSposed（解锁方法和利弊详见（二）什么是Bootloader锁）解锁后安装Magisk24.2＋并打开Zygisk，在Github下载模块后在Magisk中安装并重启，此时lsposed会默认寄生在并显示通知，你也可以选择创建快捷方式到 桌面或者安装Manger（不会影响隐藏效果，riru另说），进入后看到 已安装则表示安装成功（附图），如果你的设备无法解锁，~~也可以尝试使用太极（限制模块白名单作用域，更安全~~，2024年5月8日，开发者宣布永久停更太极，应用转生由于稳定性差不再推荐）或者LSpatch（与LSPosed一个开发团队，于2024年初停更），在软件内修补后安装，有本地和便携两种模式 本地可以调整模块作用域但必须保证lspatch随时保话，便携模式无法调整模块，但无需保活lspatch且可在其它设备上使用，但部分软件签名效验很强因此就算过签也无法正常使用这也是免root的弊端，且像腾讯类软件一旦破坏原签名将无法调起WX/QQ进行支付/登录，在所有接入TX第三方平台的软件上生效。（2024.01.09，机圈震动，lsposed开发者被人恶意辱骂宣布停更，并牵扯多个开源项目，目前lsposed已归档）

### 3、使用xposed模块

使用方法很简单，安装好xposed模块与要hook的软件， 在Lsposed中勾选对应的作用域即可（如果需hook系统框架则必须重启），可以在GitHub、爱玩机工具箱仓库等地方找（除此之外的地方不对安全性作保证！！请谨慎安装使用！）模块，另外注意LSP全局化虽好，但不要滥用，毕竟不是所有软件都通用一个模块。如果在勾选时发现有来软件提示在排除列表无法勾选，请去Magisk设器置中关闭遵守排除列表或在隐藏的应用中取消勾选。

### 4：为什么更推荐使用Zygisk-LSPosed？

首先，原生XP与EXP都有一个显著的缺点，无法指定模块hook的作用域， 这导致系统启动和应用启动都十分缓慢，LSPosed可以指定模块的作用域，还可以随时取消，且不用重启（系统框架除外），让我们使用方便了许多，另外从隐藏方面讲，原生XP与EXP通过直接替换注入达到hook，很容易被软件检测到，而Zygisk-LSPosed在 Zygisk中运行XP，发现可能性小（riru-LSPosed不能在Zygisk中运行，原理与原生xp差不多，且早已停更），且由于原生XP作者很早就停止了开发，虽然后来有EXP接手（现在开发者也是鸽子了……），但目前最高只支持Android10，支持的xposedAPI版本比较低了且不支持native hook 因此不论从哪方面讲，我们都更推荐Zygisk-lsposed（除非安卓版本过低用不了）

## 5、xposed使用注意事项

①请谨慎hook系统类应用和系统框架，一方面若hook不当会导致无法正常使用（一般卸载模块重启即可解决，建议提前安装救砖模块防止重启卡二屏导致进不了系统，另 一方面如果模块含恶意行为，那么大概率无法感知到，第三方应用同理，因此，日常使用请尽量选择Github开源的摸块或可信度高的xposed.

②一般xposed都有推荐作用域和对应软件适配版本范围，超出作用域适配范围外的hook可能不起作用或部分功能失效。

③xposed并不是万能的，它不能办到所有你想干的事， 特别当软件涉及到检测xposed等行为/加固/服务器验证会导致xposed失效或软件闪退，~~此时应更换软件或老老实实用~~